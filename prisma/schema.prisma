generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

/* -------- Types embarqués -------- */

type SiteActivities {
  id          String
  name        String
  description String
  duration    String
}

/* -------- Modèle User -------- */

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  email        String   @unique
  password     String
  firstName    String
  lastName     String
  role         String   @default("Superviseur") // "Superviseur" | "Agent" | "PDG"
  phone        String?
  profileImage String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  reviews   Review[]
  bookings  Booking[]
  sites     Site[]   @relation("SiteManager")
}

/* -------- Modèle Site -------- */

model Site {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  description  String
  location     String?
  country      String
  city         String
  image        String
  images       String[]
  currency     String           @default("XOF")
  price        Float            // prix par personne
  rating       Float            @default(0)
  maxCapacity  Int              // capacité par jour (BigInt → Int)
  tags         String[]
  openHours    String?
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Coordonnées (optionnel)
  latitude     Float?
  longitude    Float?

  // Activités embarquées
  activities       SiteActivities[]
  // Dates complètes (pour calendrier)
  unavailableDates String[]

  // Relations
  managerId   String?  @db.ObjectId
  manager     User?    @relation("SiteManager", fields: [managerId], references: [id])

  reviews     Review[]
  bookings    Booking[]

  @@index([name, city, country])
  @@map("Site") // collection Mongo "Site"
}

/* -------- Modèle Review (UN SEUL, propre) -------- */

model Review {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  rating    Int      // 1-5
  comment   String
  status    String   @default("approved") // "approved" | "pending" | "rejected"
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime  @updatedAt
  location  String  
  // Relations
  userId    String?  @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])

  siteId    String   @db.ObjectId
  site      Site     @relation(fields: [siteId], references: [id])

  @@unique([userId, siteId])
  @@index([status, rating])
  @@map("reviews") // collection Mongo "reviews"
}

/* -------- Modèle Booking -------- */

model Booking {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  status         String   @default("completed") // "pending" | "confirmed" | "cancelled" | "completed"
  startDate      DateTime
  endDate        DateTime?
  numberOfPeople Int
  reference      String?  @unique
  totalPrice     Float
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  time           String
  visitorName    String                          // ← AJOUTER
  visitorEmail   String                          // ← AJOUTER
  visitorPhone   String                          // ← AJOUTER
  visitorCountry String                          // ← AJOUTER
  visitorCity    String                         // ← AJOUTER
  paymentMethod  String?                         // ← AJOUTER : "mobile" | "card"
  paymentProvider String?                        // ← AJOUTER : "orange", "mtn", "wave", etc.
  paymentMobile  String?                         // ← AJOUTER : numéro mobile money
  paymentStatus  String   @default("paid")    // ← AJOUTER : "pending" | "paid" | "failed"
  isScanned    Boolean  @default(false)    // ← AJOUTER : validé par le manager
  // Relations
  userId   String? @db.ObjectId
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  siteId   String  @db.ObjectId
  site     Site    @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([status, startDate, reference])
  @@map("Booking") // collection "Booking" si tu veux, sinon supprime
}

/* -------- Modèle Stats (dashboard) -------- */

model Stats {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  totalVisitors Int      @default(0)
  totalReviews  Int      @default(0)
  yearsOfExp    Int      @default(12)
  totalSites    Int      @default(0)
  avgRating     Float    @default(4.8)
  updatedAt     DateTime @updatedAt

  @@map("stats") // collection "stats"
}
